{"version":3,"sources":["bin/server.js"],"names":[],"mappings":"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","file":"bin/server.js","sourcesContent":["/*  ==== ECMAScript 6 variant ====  */\n\nvar aggregation = (base, ...mixins) => {\n\n    /*  create aggregation class  */\n    let aggregate = class __Aggregate extends base {\n        constructor (...args) {\n            /*  call base class constructor  */\n            super(...args)\n\n            /*  call mixin's initializer  */\n            mixins.forEach((mixin) => {\n                if (typeof mixin.prototype.initializer === \"function\")\n                    mixin.prototype.initializer.call(this)\n            })\n        }\n    };\n\n    /*  copy properties  */\n    let copyProps = (target, source) => {\n        Object.getOwnPropertyNames(source)\n            .forEach((prop) => {\n            if (prop.match(/^(?:initializer|constructor|prototype|arguments|caller|name|bind|call|apply|toString|length)$/))\n                return\n            Object.defineProperty(target, prop, Object.getOwnPropertyDescriptor(source, prop))\n        })\n    }\n\n    /*  copy all properties of all mixins into aggregation class  */\n    mixins.forEach((mixin) => {\n        copyProps(aggregate.prototype, mixin.prototype)\n        copyProps(aggregate, mixin)\n    })\n\n    return aggregate\n}\nclass Model {\n\n  constructor(){\n    this.__uid = '';\n    this.__rev = 0;\n    this.__data = {};\n    this.__schema = '';\n  }\n\n\n  initFromData(data){\n    this.__data = data;\n    this.__uid = this._generateUUID();\n    return this;\n  }\n\n  getFromUID(uid){\n    if(typeof this.onPreGet === 'function'){\n      this.onPreGet();\n    }\n    if(typeof this._doGet === 'function'){\n      this._doGet(uid); //impl by subclass\n    }\n    if(typeof this.onPostGet === 'function'){\n      this.onPostGet();\n    }\n    return this;\n  }\n\n  remove(){\n    var res = false;\n    if(typeof this.onPreRemove === 'function'){\n      this.onPreRemove();\n    }\n    if(typeof this._doRemove === 'function'){\n      res = this._doRemove(); //impl by subclass\n    }\n    if(typeof this.onPostRemove === 'function'){\n      this.onPostRemove();\n    }\n    return res;\n  }\n\n  put(){\n    var res = false;\n    if(typeof this.onPrePut === 'function'){\n      this.onPrePut();\n    }\n    if(typeof this._doPut === 'function'){\n      res = this._doPut(); //impl by subclass\n    }\n    if(typeof this.onPostPut === 'function'){\n      this.onPostPut();\n    }\n    return res;\n  }\n\n  get(key=''){\n    let parts = key.split('.');\n    let res = this.__data;\n    for(let i=0;i<parts.length;i++){\n      if(typeof res === 'object'){\n        res = res[parts[i]]\n      }else{\n        res = undefined;\n        break;\n      }\n    }\n    return res;\n  }\n\n  set(key='',value){\n    let parts = key.split('.');\n    let current = this.__data;\n    for(var i=0;i<parts.length-1;i++){\n      var next = current[parts[i]];\n      if(typeof next !== 'object'){\n        current[parts[i]] = {};\n        next = current[parts[i]];\n      }\n      current = next;\n    }\n    current[parts[parts.length-1]] = value;\n  }\n\n  _generateUUID() {\n    var d = new Date().getTime();\n    var uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {\n        var r = (d + Math.random()*16)%16 | 0;\n        d = Math.floor(d/16);\n        return (c=='x' ? r : (r&0x3|0x8)).toString(16);\n    });\n    return uuid;\n  }\n}\n\n/*global Model*/\n\nclass ServerModel extends Model {\n  constructor(){\n    super();\n  }\n  \n  _doGet(uid){\n    this.__uid = uid;\n    let raw = db.get(this.__name+\":\"+this.__uid);\n    this.__data = JSON.parse(raw);\n  }\n\n  _doRemove(){\n    return db.remove(this.__name+\":\"+this.__uid);\n  }\n  \n  _doPut(){\n    let key = this.__name+\":\"+this.__uid;\n    let value = JSON.stringify(this.__data);\n    return db.put(key,value);\n  }\n}\n\n\n\nclass ServerApp {\n    constructor(){\n        this.__models = {};\n        this.__pages = [];\n        this.__debugLogs = true;\n        this._initDebugLogs();\n    }\n\n    _initDebugLogs(){\n        let orig = console.log;\n        if(this.__debugLogs){\n            console.debug = (...args) => console.log('ServerJS>',...args);\n        }else{\n            console.debug = (...args) => {};\n        }\n    }\n\n    Model(name, ...mixins){\n        console.debug(`declare server model ${name}...`);\n        this.__models[name] = aggregation(ServerModel, ...mixins);\n    }\n\n    CreateModel(name, ...args){\n        var model = new this.__models[name](...args);\n        model.__name = name;\n        return model;\n    }\n\n    Page(url,renderer){\n        console.debug(`declare page for url: ${url}`);\n        this.__pages.push({url,renderer});\n    }\n\n    renderPage(){\n        var renderer = null;\n        for(let i=0;i<this.__pages.length;i++){\n            if(URL.match(this.__pages[i].url)){\n                renderer = this.__pages[i].renderer;\n                break;\n            }\n        }\n        if(renderer === null){\n            console.debug(\"no renderer found... sending 404\");\n            return {\n                body: '',\n                status: 404,\n                header: {}\n            };    \n        }\n        var result = renderer();\n        result.body = result.body || '';\n        result.status = result.status || 200;\n        result.header = result.header || {};\n        return result;\n    }\n\n}\n\nvar restless  = new ServerApp();\nrestless.Model('Project', class {\n  \n  onPreGet(){\n    if(ROLE !== 'admin') throw 'no right!';\n  }\n  onPostGet(){\n    //this.set('example.dynamic.requestTime',(new Date()).toString());\n  }\n\n  onPreRemove(){\n    if(ROLE !== 'admin') throw 'no right!';\n    let translationKeys = this.get('keys')\n    for(let i=0;i<translationKeys.length;i++){\n      let translation = restless.CreateModel(\"Translation\")\n      translation.getFromUID(translationKeys[i])\n      translation.remove()\n    }\n  }\n  onPostRemove(){\n    console.debug(`deleted project ${this.__uid}`);\n  }\n\n  onPrePut(){\n    if(ROLE !== 'admin') throw 'no right!';\n    if(this.get('keys') === undefined){\n      this.set('keys',[])\n    }\n  }\n  onPostPut(){\n    console.debug(`updated project ${this.__uid}`);\n  }\n  \n  \n});\n\n\nrestless.Model('Translation', class {\n  \n  onPreGet(){\n    if(ROLE !== 'admin') throw 'no right!';\n  }\n\n  onPreRemove(){\n    if(ROLE !== 'admin') throw 'no right!';\n    let project = restless.CreateModel('Project')\n    project.getFromUID(this.get('pid'))\n    let translationKeys = project.get('keys')\n    for(let i=0; i< translationKeys.length; i++){\n      if(translationKeys[i] === this.__uid){\n        console.debug(`deleted key ${this.__uid} from project ${project.__uid}`)\n        translationKeys.splice(i,1)\n        project.put()\n        break;\n      }\n    }\n  }\n  onPostRemove(){\n    console.debug(`deleted translation ${this.__uid} of project ${this.get('pid')}`);\n  }\n\n  onPrePut(){\n    if(ROLE !== 'admin') throw 'no right!';\n  }\n  onPostPut(){\n    let project = restless.CreateModel('Project')\n    project.getFromUID(this.get('pid'))\n    let translationKeys = project.get('keys')\n    if(! contains(translationKeys,this.__uid)){\n      translationKeys.push(this.__uid);\n      project.put()\n      console.debug(`added key ${this.__uid} to project ${project.__uid}`)\n    }\n    console.debug(`updated translation ${this.__uid} of project ${this.get('pid')}`);\n  }\n\n});\n\nfunction contains(arr,elem){\n  for(var i=0;i<arr.length;i++){\n    if(arr[i]===elem){\n      return true;\n    }\n  }\n  return false;\n}\n\nrestless.Page('^/langfile', () => {\n    let parts = URL.split('/')\n    if (parts.length < 3) {\n        throw 'call this url with /langfile/<projectid>/<locale>'\n    }\n    if (METHOD === 'GET') {\n        let langFile = new LanguageFile(parts[2], parts[3])\n        return {\n            status: 200,\n            header: {\n                'content-type': 'application/json'\n            },\n            body: JSON.stringify(langFile.getData())\n        }\n    } else if (METHOD === 'POST') {\n        let langFile = new LanguageFile(parts[2], parts[3])\n        return {\n            status: 200,\n            header: {\n                'content-type': 'application/json'\n            },\n            body: JSON.stringify(langFile.setData(JSON.parse(BODY)))\n        }\n    } else {\n        return {\n            status: 404,\n            body: 'not an implemented http verb: ' + METHOD\n        }\n    }\n});\n\n\nvar timesaver = {\n    dirty: true\n}\n\nclass LanguageFile {\n    constructor(projectid, locale) {\n        this.defaultLocale = 'en_gb'\n        this.locale = locale\n        if (timesaver.dirty) {\n            this.project = restless.CreateModel('Project')\n            this.project.getFromUID(projectid)\n            console.debug(`got project ${this.project.__uid}`)\n            let translationKeys = this.project.get('keys')\n            console.debug(`got ${translationKeys.length} projectkeys`)\n            this.translations = {}\n            for (var i = translationKeys.length - 1; i >= 0; i--) {\n                let t = restless.CreateModel('Translation')\n                t.getFromUID(translationKeys[i])\n                this.translations[t.get('key')] = t\n                console.debug(`loaded translation: ${t.__uid}`)\n            }\n            timesaver.project = this.project\n            timesaver.translations = this.translations\n            timesaver.dirty = false\n        } else {\n            this.project = timesaver.project\n            this.translations = timesaver.translations\n        }\n    }\n\n    getData() {\n        var result = {}\n        let translationKeys = Object.keys(this.translations)\n        console.debug(`got ${translationKeys.length} keys`)\n        for (var i = translationKeys.length - 1; i >= 0; i--) {\n            let key = translationKeys[i]\n            let translation = this.translations[key]\n            if (this.locale === 'all') {\n                result[translation.get('key')] = translation.get('translations')\n                result[translation.get('key')].__internalKey = translation.get('__internalKey')\n            } else if (translation.get('translations.' + this.locale) !== undefined) {\n                result[translation.get('key')] = translation.get('translations.' + this.locale);\n            } else {\n                result[translation.get('key')] = translation.get('translations.' + this.defaultLocale);\n            }\n        }\n        return result\n    }\n\n    setData(data) {\n        let count = 0\n        let max = Object.keys(data).length\n        for (let key in data) {\n            let myTranslation = this.translations[key]\n            if (myTranslation === undefined && this.locale === this.defaultLocale) { // we have no local definition for this key\n                let translation = restless.CreateModel(\"Translation\")\n                translation.initFromData({\n                    pid: this.project.__uid,\n                    key: key\n                })\n                translation.set('translations.' + this.locale, data[key])\n                translation.set('__internalKey', translation.__uid)\n                translation.put()\n                timesaver.project.__data.keys.push(translation.__uid)\n                timesaver.translations[key] = translation\n                this.translations[key] = translation\n            } else if (myTranslation !== undefined) {\n                let myStr = myTranslation.get('translations.' + this.locale)\n                let myDefault = myTranslation.get('translations.' + this.defaultLocale)\n                if (myStr === undefined) {\n                    if (myDefault !== data[key]) {\n                        console.debug(`translation differs from default translation: ${data[key]} <!> ${myDefault}`)\n                        myTranslation.set('translations.' + this.locale, data[key])\n                        myTranslation.put()\n                        timesaver.translations[key] = myTranslation\n                    }\n                } else if (myStr !== data[key]) {\n                    myTranslation.set('translations.' + this.locale, data[key])\n                    myTranslation.put()\n                    timesaver.translations[key] = myTranslation\n                }\n            }\n            count++\n            console.debug(`imported ${count} / ${max}\\t(${((1.0)*count)/((1.0)*max)*100.}%)`)\n        }\n        return true\n    }\n}\nrestless.Page('^/test$', ()=>{\n    \n    return {\n        body: `\nUrl: ${URL}\nMethod: ${METHOD}\nHeaders: ${JSON.stringify(HEADERS)}\nUser: ${USERNAME}\nRole: ${ROLE}\nBody: ${BODY}\n\n`\n    }\n})\n"]}